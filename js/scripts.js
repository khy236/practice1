// my token
mapboxgl.accessToken = 'pk.eyJ1Ijoia2h5MjM2IiwiYSI6ImNsZzVxYTVnNDA1d2kzZW45b3l5d280N3oifQ.GqfNX5HwLaA5utEN2iQkXg';


// initialize chart
let ctx = document.getElementById('chart');

// dummy chart
var tempChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [0],
    datasets: [{
      data: [0]
    }]
  }
});

// hide dummy chart
document.getElementById('chart').style.display = "none";


// shading mask boundaries
var bounds = [-74.62413, 40.39242, -73.36096, 41.22521]

// initialize basemap
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [-73.88661930570889, 40.750486754379065], // Jackson Heights
  pitch: 40,
  bounds: [-73.90516, 40.74195, -73.86543, 40.76525]
});

map.addControl(new mapboxgl.NavigationControl());

map.on('load', function () {

  // jackson heights NTA border
  map.addSource('jackson_heights_geojson', {
    type: 'geojson',
    data: jackson_heights
  })

  map.addLayer({
    id: 'line-jh',
    type: 'line',
    source: 'jackson_heights_geojson',
    'layout': {
      'visibility': 'visible'
    },
    paint: {
      'line-width': 5,
      'line-color': '#857271'
    }
  })


  // add mask outside jackson heights NTA
  map.addSource('outside_jackson_heights', {
    type: 'geojson',
    data: polyMask(mask, bounds)
  })

  map.addLayer({
    "id": "outside_jh_mask",
    "source": "outside_jackson_heights",
    'layout': {
      'visibility': 'visible'
    },
    "type": "fill",
    "paint": {
      "fill-color": "#857271",
      'fill-opacity': 0.5
    }
  });


   // real estate sold >4x since 2003 (PLUTO polygons)
  map.addSource('reflips_geojson', {
    type: 'geojson',
    data: reflips_w_pluto
  })

  map.addLayer({
    id: 'fill-reflips',
    type: 'fill',
    source: 'reflips_geojson',
    paint: {
      'fill-color': '#A90A03',
      'fill-opacity': 0.5
    }
  })//, 'road-label-simple') // place polygons below road labels


  // user clicks on a lot
  map.on('click', 'fill-reflips', (e) => {

    const feature = e.features[0];
    bbl = Math.round(feature.properties.BBL);
    address = feature.properties.address_todisplay;
    
    console.log(feature.properties);
    
    // find all sales matching BBL
    var lot_sales = $.grep(reflips, function (element, index) {
      return element.address == address;
    });

    // make chart of sales data
    makeChart(lot_sales, $("#chart"));

    // add details to description div
    $('#description').html(`
    <div>
    <br>
    <h2><b>Address</b></h2>
    <h3>
        ${feature.properties.address_todisplay},
        <br>
        ${feature.properties.borough}, New York ${feature.properties.zipcode}
    <h2><b>Property details</b></h2>
    <p>
      Year built: ${feature.properties.yearbuilt}<br>
      Building class category: ${feature.properties.building_class_category}<br>
      Total units: ${feature.properties.units}<br>
      Residential units: ${feature.properties.unitsres_todisplay}<br>
      Commercial units: ${feature.properties.unitscomm}<br>  
    </p>
    <h2><b>Sales history</b></h2>
    <p>
        This property has been sold ${lot_sales.length} time(s) since 2003.
    <h2><b>Price history</b></h2>
        The chart below shows the property's sales price over time, excluding $0 transactions.
    </p>
    </div>`);

  });


  // buttons

  // button to hide jackson heights NTA mask
  $('#remove-mask').on('click', function () {
    map.setLayoutProperty('outside_jh_mask', 'visibility', 'none');
    map.setLayoutProperty('line-jh', 'visibility', 'none');
    map.fitBounds([-74.25581, 40.41798, -73.73367, 40.94616]);
  })

  // button to show jackson heights NTA mask
  $('#show-mask').on('click', function () {
    map.setLayoutProperty('outside_jh_mask', 'visibility', 'visible');
    map.setLayoutProperty('line-jh', 'visibility', 'visible');
    map.fitBounds([-73.90516, 40.74195, -73.86543, 40.76525]);
  })

 // button to return to home page
  $('#home').on('click', function () {
    document.getElementById('chart').style.display = "none";
    $('#description').html(`
    <h2>
      <br>
      Description TBD.
    </h2>
    `);
  })

})


// function that creates sales chart
let makeChart = (data, chartDiv) => {

  // unhide chart div
  document.getElementById('chart').style.display = "";

  // destroy previous chart
  tempChart.destroy();

  // create array of sale dates and array of sale prices
  var x_saledates = [];
  var y_saleprices = [];

  data.forEach(object => {
    if (object['saleprice'] != 0) { // filter our $0 transactions
      x_saledates.push(new Date(object['sale_date']));
      y_saleprices.push(object['saleprice']);
    }
  });

  //sort dates array
  x_saledates.sort((a, b) => a - b);

  // create new chart
  tempChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: x_saledates,
      datasets: [{
        label: 'Sale price ($)',
        data: y_saleprices,
        borderColor: '#CF807D',
        borderWidth: 1.5,
        borderCapStyle: "round",
        tension: 0.1,
        pointBackgroundColor: '#857271', // color options: 6b4f4d, 857271
        pointBorderWidth: 0,
        pointRadius: 2.5
      }]
    },
    options: {
      scales: {
        x: {
          type: "time",
          time: {
            parser: 'MM/DD/YYYY HH:mm',
            tooltipFormat: 'MM/dd/yyyy', // format popup dates MM/DD/YYYY
            unit: 'year', // format x axis as YYYY
            unitStepSize: 1,
            displayFormats: {
              'year': 'yyyy'
            }
          }
        },
        y: {
          ticks: {
            callback: function (value, index, ticks) {
              return '$' + Chart.Ticks.formatters.numeric.apply(this, [value, index, ticks]); // format y axis as $XXX,XXX
            }
          }
        }
      }
    }
  });

}


// function that formats number as USD $ 
// from: https://stackoverflow.com/questions/149055/how-to-format-numbers-as-currency-strings 
const formatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  minimumFractionDigits: 0, // round to whole number
  maximumFractionDigits: 0, // round to whole number
});


// function that creates mask outside jackson heights
// from https://jsfiddle.net/kmandov/cr2rav7v
function polyMask(mask, bounds) {
  var bboxPoly = turf.bboxPolygon(bounds);
  return turf.difference(bboxPoly, mask);
}

var mask = turf.polygon([
  [
    [-73.873658626319, 40.7568117548411],
    [-73.872712082386, 40.7550717901179],
    [-73.8726938152017, 40.7550382089572],
    [-73.8726710782077, 40.7549950684796],
    [-73.8721437348427, 40.7539943179069],
    [-73.8720718803738, 40.753870257284],
    [-73.8717938498505, 40.7533339387126],
    [-73.8709665634939, 40.7517834859457],
    [-73.8708435640387, 40.7515529615106],
    [-73.8696869163372, 40.7496206303688],
    [-73.869425992867, 40.7491651194768],
    [-73.869740545014, 40.7491345386972],
    [-73.8703802196287, 40.7490723463709],
    [-73.870971940198, 40.7490075105288],
    [-73.8713578927016, 40.7489652185531],
    [-73.8718423663985, 40.7489138452673],
    [-73.8723739710534, 40.7488598197532],
    [-73.8727749763043, 40.7488212263845],
    [-73.8733045088446, 40.7487663928365],
    [-73.8737023912003, 40.7487255874624],
    [-73.8739843458689, 40.7486939372731],
    [-73.8746308718413, 40.7486221960714],
    [-73.8754337701313, 40.7485356279116],
    [-73.8755578400672, 40.7485218761987],
    [-73.8762532115108, 40.7484471178296],
    [-73.8764809396187, 40.7484246703796],
    [-73.8769259919836, 40.7483772569016],
    [-73.8774175334251, 40.7483276417218],
    [-73.8783445352771, 40.7482309276063],
    [-73.8784592023756, 40.7482230782694],
    [-73.8792792093904, 40.7481323608291],
    [-73.8798403593585, 40.748069993127],
    [-73.8802078903056, 40.7480332480361],
    [-73.8811388866761, 40.7479355610522],
    [-73.8820725320478, 40.7478381943398],
    [-73.8825701809551, 40.7477861131478],
    [-73.88300059449, 40.7477426703355],
    [-73.8839372064073, 40.7476385098043],
    [-73.8848567959755, 40.7475430793745],
    [-73.8857888160782, 40.7474480222379],
    [-73.8867179747703, 40.7473497300302],
    [-73.8876480502734, 40.7472531070667],
    [-73.8877846817614, 40.7472371941212],
    [-73.8886790752492, 40.7471425452013],
    [-73.8895726963182, 40.7470473212774],
    [-73.890502705027, 40.7469502060381],
    [-73.8914327004971, 40.7468530040336],
    [-73.8917519018029, 40.7468199946994],
    [-73.8924104803526, 40.7471435957724],
    [-73.8937985023633, 40.7476997674276],
    [-73.8952774212176, 40.7483255610292],
    [-73.8954107541191, 40.7483821259535],
    [-73.8956461130404, 40.7484819724159],
    [-73.8957292077293, 40.7485193106459],
    [-73.8958160425713, 40.7485592078375],
    [-73.8958594246196, 40.7485775705839],
    [-73.8959591958366, 40.7486188994618],
    [-73.8960529429087, 40.748657732915],
    [-73.8961109259023, 40.7486776810269],
    [-73.8961467562534, 40.7486883042001],
    [-73.8962438711972, 40.7487278132125],
    [-73.8963601130473, 40.7487785578694],
    [-73.8965293298218, 40.7490710001363],
    [-73.8968667303508, 40.749614713588],
    [-73.8970763022884, 40.7499530800622],
    [-73.8971448087866, 40.7500787943665],
    [-73.8972067762541, 40.7502064559914],
    [-73.8972394449039, 40.7502807553335],
    [-73.8972767921608, 40.7503734156673],
    [-73.8973107209997, 40.7504668338684],
    [-73.8973692915916, 40.7506984693735],
    [-73.8973979609084, 40.7508118488917],
    [-73.8974600718963, 40.7510716616429],
    [-73.8974805838854, 40.7511574657629],
    [-73.8975740271484, 40.7517726308984],
    [-73.8975952570661, 40.7520471763883],
    [-73.8976010235532, 40.7520851099475],
    [-73.8976075989348, 40.7521229667817],
    [-73.8976789803405, 40.7523935405515],
    [-73.8976840864483, 40.7524081504011],
    [-73.8978053319868, 40.7527096026004],
    [-73.8978661154865, 40.7528295220156],
    [-73.8979333369907, 40.7529474380713],
    [-73.898217065493, 40.7533748416026],
    [-73.8984005697248, 40.753651269924],
    [-73.8986671835238, 40.7540528829127],
    [-73.898739580621, 40.7541619384443],
    [-73.8986308905643, 40.7541697907182],
    [-73.8985436472296, 40.7541783803844],
    [-73.8986054912816, 40.7542855833673],
    [-73.8988641224578, 40.7547201032331],
    [-73.8988778658127, 40.7547546587134],
    [-73.8989712407961, 40.7549894269434],
    [-73.8989922969371, 40.755034738163],
    [-73.8991223312532, 40.7553145600991],
    [-73.8992264246205, 40.7555503181384],
    [-73.8994815250689, 40.7562548492479],
    [-73.8995930885668, 40.7565638767972],
    [-73.899692234683, 40.7570305872916],
    [-73.8997351877117, 40.7573942066006],
    [-73.8997398366076, 40.7574291043447],
    [-73.899743389851, 40.7574696671172],
    [-73.8997446885411, 40.75750141918],
    [-73.8997436280815, 40.7575411359639],
    [-73.8997413241432, 40.7575761483239],
    [-73.8997348683387, 40.7576252652937],
    [-73.8997305548329, 40.7576452644733],
    [-73.8997027165155, 40.7578035806646],
    [-73.8996559972335, 40.757989661002],
    [-73.899608244874, 40.7581499103107],
    [-73.8995538256151, 40.758308924593],
    [-73.8994895052235, 40.7584745417205],
    [-73.8994179536605, 40.7586384334299],
    [-73.8993392493117, 40.7588004196754],
    [-73.8990446128389, 40.7592522480661],
    [-73.8990020494856, 40.7593175208232],
    [-73.8987539727379, 40.7596597464037],
    [-73.8985563468915, 40.7599323725803],
    [-73.8986627960772, 40.7599292874809],
    [-73.8987739243803, 40.7599238461697],
    [-73.898568847299, 40.7602035915099],
    [-73.8982580589826, 40.7606706950659],
    [-73.8980142679717, 40.7610212173326],
    [-73.8980126762167, 40.7610235725459],
    [-73.8978261771018, 40.7612999632787],
    [-73.8978206729547, 40.7613081223779],
    [-73.8976152279943, 40.7615983808445],
    [-73.8975223883419, 40.7617386357379],
    [-73.8973852460809, 40.7619337747161],
    [-73.8973538022571, 40.7619784639923],
    [-73.8973482071173, 40.7619864194731],
    [-73.8971506621038, 40.7622675259871],
    [-73.8970247774631, 40.7624225732774],
    [-73.896837171487, 40.762678942241],
    [-73.8967741637495, 40.76276996199],
    [-73.8965523747119, 40.7630903545721],
    [-73.8965088317693, 40.7631479928153],
    [-73.8964578975017, 40.763213107596],
    [-73.8963938909245, 40.7632771029775],
    [-73.8963196883858, 40.7633554440985],
    [-73.896217876701, 40.7634426023627],
    [-73.8961131682752, 40.7635264431651],
    [-73.8959881117598, 40.7636190931537],
    [-73.8958586967094, 40.7637100875397],
    [-73.8956595013228, 40.7638391207709],
    [-73.8955009957055, 40.763961562853],
    [-73.8954006341973, 40.764044851334],
    [-73.8953843339479, 40.7640599082853],
    [-73.8952871846125, 40.7641496652087],
    [-73.8952455913998, 40.7641924365022],
    [-73.8952013456147, 40.7642379356986],
    [-73.8950980129241, 40.764364847972],
    [-73.8950361104046, 40.7644742578687],
    [-73.8949593813445, 40.7646740730077],
    [-73.8949563915848, 40.7646765907949],
    [-73.8948036411877, 40.7651431569684],
    [-73.8946446762085, 40.7656091958341],
    [-73.8946076904394, 40.7657176251017],
    [-73.8945616269378, 40.7658233571416],
    [-73.8945012244541, 40.7659279855215],
    [-73.8944336757942, 40.7660195139826],
    [-73.8943251356705, 40.7661547423254],
    [-73.8940839506295, 40.7663379266453],
    [-73.8940115769571, 40.7663877570535],
    [-73.893861292977, 40.7664297163993],
    [-73.8932433627009, 40.7663448591597],
    [-73.8928550997355, 40.7663117293838],
    [-73.8927827683788, 40.7663082329747],
    [-73.892464953429, 40.7662928695404],
    [-73.8920742996666, 40.7662883619449],
    [-73.891836651344, 40.7662886892963],
    [-73.8910916930209, 40.766344906629],
    [-73.8910722033516, 40.7662836097605],
    [-73.8910380195447, 40.7662045662537],
    [-73.8910038500434, 40.7661255155453],
    [-73.8908918518574, 40.7658664684993],
    [-73.890721442411, 40.765895151064],
    [-73.8904254466031, 40.765970331337],
    [-73.8899502828627, 40.7661126804985],
    [-73.889186619123, 40.7663059631877],
    [-73.8887745201287, 40.7665195980576],
    [-73.8883434329822, 40.7666050712328],
    [-73.8883561264199, 40.7667059850835],
    [-73.8883668775779, 40.7667778638783],
    [-73.8878084091692, 40.7669032750131],
    [-73.8877312964183, 40.7669227057306],
    [-73.8877080322426, 40.7668468695716],
    [-73.8876748810109, 40.7667476817867],
    [-73.8875729605556, 40.7664193943391],
    [-73.8875557914588, 40.7663682199105],
    [-73.8875426311787, 40.7663263957305],
    [-73.8871069080409, 40.765066038186],
    [-73.8870910533314, 40.765021725912],
    [-73.8870794643625, 40.7649559876003],
    [-73.8870652945507, 40.764881240807],
    [-73.8867955283001, 40.7634122064112],
    [-73.8867311396734, 40.7630615314403],
    [-73.8863985362833, 40.7612247233309],
    [-73.8854689585689, 40.7613236870182],
    [-73.8845378991771, 40.7614217943456],
    [-73.8836084973436, 40.761519275376],
    [-73.8831279580863, 40.761569426116],
    [-73.8826779422885, 40.7616163794289],
    [-73.8823707117373, 40.7616484041996],
    [-73.8820529255311, 40.7616815231657],
    [-73.8817490679412, 40.7617131886295],
    [-73.8808194960255, 40.7618151035909],
    [-73.8803426689194, 40.7618659030237],
    [-73.8798894751382, 40.7619141838985],
    [-73.879421717186, 40.7619532733994],
    [-73.878955237947, 40.7619922524832],
    [-73.8785703142458, 40.7619180599983],
    [-73.8784333618056, 40.7618851101544],
    [-73.8779744111711, 40.7618032021533],
    [-73.8769938346488, 40.7616291461508],
    [-73.8764947905092, 40.7615388228368],
    [-73.8760151283506, 40.7614520022748],
    [-73.8758079550407, 40.760316106458],
    [-73.8755122136301, 40.7586879059852],
    [-73.8751401523076, 40.7566420857614],
    [-73.8742094397277, 40.7567398326479],
    [-73.873658626319, 40.7568117548411]
  ]
]);
